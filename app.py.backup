import streamlit as st
import openai
import pdfplumber
import time
import json

# --- 1. CONFIGURA√á√ÉO VISUAL ---
st.set_page_config(page_title="Nobile Career Strategy", page_icon="‚ôüÔ∏è", layout="wide")

st.markdown("""
<style>
    .stApp { background-color: #0E1117; color: #FAFAFA; }
    .stButton>button {
        background-color: #238636;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        font-weight: bold;
    }
    .stButton>button:hover { background-color: #2ea043; }
    .stChatMessage[data-testid="user"] { background-color: #0d4a2b; }
</style>
""", unsafe_allow_html=True)

# --- 2. O ROTEIRO MESTRE (SEU SCRIPT EXATO) ---
SYSTEM_PROMPT = """
ATUE COMO UM HEADHUNTER E ESTRATEGISTA DE CARREIRA (VERS√ÉO ELITE GLOBAL).
Role: Voc√™ √© um Headhunter Executivo S√™nior, Especialista em ATS e LinkedIn Top Voice.
Regra de Ouro: Voc√™ constr√≥i um perfil de Alta Performance. Em cada etapa, voc√™ PAUSA, entrevista e valida.

ESTRUTURA DE FASES (Siga rigorosamente):

FASE 1: DIAGN√ìSTICO (O PRIMEIRO PASSO)
- Leia o CV. Identifique a √°rea macro.
- Responda: "Entendi. Atuarei como especialista em [√Årea]. Para tra√ßarmos a estrat√©gia, responda:"
- Pergunte P1 (Objetivo), P2 (Cargos Espec√≠ficos), P3 (Pretens√£o Realista), P4 (Localiza√ß√£o).
- AGUARDE AS RESPOSTAS. N√ÉO AVANCE.

FASE 2: MENU
- S√≥ libere o Menu ap√≥s ter as respostas P1-P4.

FASE 3: EXECU√á√ÉO (QUANDO O USU√ÅRIO ESCOLHER NO MENU)
- Etapa 1 (SEO): Liste 10 palavras-chave do Cargo P2. Compare com o CV. Pergunte sobre as faltantes. PAUSE.
- Etapa 2 (M√©tricas): Para cada experi√™ncia, desafie: "Preciso de n√∫meros. Qual impacto (R$, %)?". PAUSE.
- Etapa 3 (Curadoria): Pergunte: "Tem alguma conquista indispens√°vel que n√£o cobrimos?". PAUSE.
- Etapa 4 (Engenharia): Reescreva Resumo e Experi√™ncias usando estruturas de alta performance.
- Etapa 5 (Arquivo Mestre): Gere o texto final.

IMPORTANTE: Mantenha o tom consultivo e estrat√©gico.
"""

# --- 3. FUN√á√ïES ---
def extract_text(file):
    try:
        with pdfplumber.open(file) as pdf:
            return "\n".join([p.extract_text() for p in pdf.pages if p.extract_text()])
    except: return None

def get_response(messages, api_key):
    if not api_key: return "‚ö†Ô∏è Insira a API Key na barra lateral."
    client = openai.OpenAI(api_key=api_key)
    try:
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=messages,
            temperature=0.5
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"Erro na IA: {e}"

def extract_role_from_cv(cv_text, api_key):
    """Extrai o cargo/fun√ß√£o principal do CV"""
    if not api_key: return "Cargo n√£o identificado"
    client = openai.OpenAI(api_key=api_key)

    MAX_CV_TEXT_LENGTH = 2000

    prompt = f"""
    Analise este CV e identifique o cargo/fun√ß√£o principal da pessoa.

    CV: {cv_text[:MAX_CV_TEXT_LENGTH]}

    Retorne APENAS o nome do cargo/fun√ß√£o (ex: "Gerente de Vendas", "Desenvolvedor Python", "Diretor Comercial").
    Seja espec√≠fico e conciso (m√°ximo 4 palavras).
    """
    try:
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.3
        )
        role = response.choices[0].message.content.strip()
        return role if role else "Profissional"
    except Exception as e:
        return "Profissional"

def calculate_ats_score(cv_text, target_role, api_key):
    """Calcula o Score ATS e identifica keywords faltantes"""
    if not api_key: return None
    client = openai.OpenAI(api_key=api_key)

    MAX_CV_TEXT_LENGTH = 3000

    prompt = f"""
    ATUE COMO: Auditor de RH e Especialista em ATS.
    CONTEXTO:
    - CV Texto: {cv_text[:MAX_CV_TEXT_LENGTH]}
    - Cargo Alvo: {target_role}

    TAREFA (Retorne JSON):
    1. **ATS_Score**: Calcule a % de palavras-chave do cargo presentes no CV (0-100).
    2. **Keywords_Present**: Liste 5-10 palavras-chave PRESENTES no CV.
    3. **Keywords_Missing**: Liste 5-10 palavras-chave cr√≠ticas que FALTAM.
    4. **Recomendacoes**: Liste 3 recomenda√ß√µes curtas para melhorar o score.

    FORMATO JSON OBRIGAT√ìRIO:
    {{
        "ats_score": 0,
        "keywords_present": ["k1", "k2", "k3"],
        "keywords_missing": ["k1", "k2", "k3"],
        "recomendacoes": ["r1", "r2", "r3"]
    }}
    """
    try:
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[{"role": "user", "content": prompt}],
            response_format={"type": "json_object"},
            temperature=0.2
        )
        return json.loads(response.choices[0].message.content)
    except Exception as e:
        st.error(f"Erro no c√°lculo ATS: {e}")
        return None

# --- 4. CONTROLE DE ESTADO ---
if "messages" not in st.session_state:
    st.session_state.messages = [{"role": "system", "content": SYSTEM_PROMPT}]
if "cv_content" not in st.session_state: st.session_state.cv_content = None
if "fase_atual" not in st.session_state: st.session_state.fase_atual = "UPLOAD"
if "ats_data" not in st.session_state: st.session_state.ats_data = None
if "target_role" not in st.session_state: st.session_state.target_role = ""

# --- 5. SIDEBAR ---
with st.sidebar:
    st.image("https://cdn-icons-png.flaticon.com/512/3048/3048127.png", width=60)
    st.title("Nobile Strategy")
    api_key = st.text_input("OpenAI API Key", type="password")

    st.markdown("---")
    if st.button("üîÑ Reiniciar Sess√£o"):
        for key in list(st.session_state.keys()): del st.session_state[key]
        st.rerun()

# --- 6. INTERFACE PRINCIPAL ---
st.title("Headhunter Elite Global AI")

# EXIBIR ATS SCORE NO TOPO (Dashboard sempre vis√≠vel)
if st.session_state.ats_data and st.session_state.ats_data != "calculating":
    st.markdown("---")

    data = st.session_state.ats_data
    score = data.get('ats_score', 0)

    # Dashboard Header com Score
    col_header1, col_header2, col_header3 = st.columns([1, 2, 2])

    with col_header1:
        color = "#4CAF50" if score >= 70 else "#FF9800" if score >= 50 else "#FF5252"
        st.markdown(f"""
        <div style="background-color: #1E1E1E; border: 3px solid {color}; padding: 20px;
             border-radius: 10px; text-align: center;">
            <div style="font-size: 3.5em; font-weight: bold; color: {color};">{score}%</div>
            <div style="font-size: 1em; color: #AAA; margin-top: 5px;">ATS Score</div>
            <div style="font-size: 0.85em; color: #888; margin-top: 5px;">Cargo: {st.session_state.target_role}</div>
        </div>
        """, unsafe_allow_html=True)

    with col_header2:
        st.markdown("**‚úÖ Keywords Presentes:**")
        keywords_present = data.get('keywords_present', [])
        if keywords_present:
            for i, kw in enumerate(keywords_present[:5]):
                st.success(f"‚Ä¢ {kw}", icon="‚úÖ")
        else:
            st.info("Nenhuma keyword identificada")

    with col_header3:
        st.markdown("**‚ùå Keywords Faltantes:**")
        keywords_missing = data.get('keywords_missing', [])
        if keywords_missing:
            for i, kw in enumerate(keywords_missing[:5]):
                st.error(f"‚Ä¢ {kw}", icon="‚ùå")
        else:
            st.success("Nenhuma keyword faltante!")

    # Recomenda√ß√µes em linha
    if data.get('recomendacoes'):
        with st.expander("üí° Ver Recomenda√ß√µes ATS", expanded=False):
            for rec in data.get('recomendacoes', []):
                st.info(f"‚Ä¢ {rec}")

    st.markdown("---")

# FASE 1: UPLOAD (Gatilho Inicial)
if not st.session_state.cv_content:
    uploaded_file = st.file_uploader("Suba seu CV (PDF)", type="pdf")

    if uploaded_file and api_key:
        with st.spinner("Lendo perfil e calculando ATS Score..."):
            text = extract_text(uploaded_file)
            st.session_state.cv_content = text
            st.session_state.fase_atual = "DIAGNOSTICO"

            # Extrai o cargo do CV automaticamente
            detected_role = extract_role_from_cv(text, api_key)
            st.session_state.target_role = detected_role

            # Calcula ATS Score automaticamente
            ats_result = calculate_ats_score(text, detected_role, api_key)
            st.session_state.ats_data = ats_result

            st.rerun()

# FASE 2: QUESTION√ÅRIO ESTRAT√âGICO (ap√≥s upload do CV)
elif not st.session_state.questionnaire_completed:
    # Detectar √°rea macro para a introdu√ß√£o
    area_macro = "Revenue Operations (RevOps) e Sales Operations" if "sales" in st.session_state.target_role.lower() or "vendas" in st.session_state.target_role.lower() or "comercial" in st.session_state.target_role.lower() else st.session_state.target_role

    st.success(f"‚úÖ CV carregado com sucesso!")
    st.info(f"**Entendi. Atuarei como especialista em {area_macro}.**")

    # Renderizar formul√°rio com fulfill boxes
    if render_questionnaire(st.session_state.target_role):
        # Quando o question√°rio for completado
        with st.spinner("Processando suas respostas..."):
            # Preparar mensagem estruturada com as respostas
            answers = st.session_state.questionnaire_answers
            structured_response = f"""
            O usu√°rio completou o question√°rio estrat√©gico. Aqui est√£o as respostas:

            P1 (Objetivo de carreira): {answers['P1']}
            P2 (Cargos espec√≠ficos): {answers['P2']}
            P3 (Pretens√£o salarial): {answers['P3']}
            P4 (Localiza√ß√£o): {answers['P4']}

            AGORA, reconhe√ßa as respostas e libere o MENU de op√ß√µes para o usu√°rio.
            """

            st.session_state.messages.append({"role": "user", "content": structured_response})
            reply = get_response(st.session_state.messages, api_key)
            st.session_state.messages.append({"role": "assistant", "content": reply})
            st.session_state.fase_atual = "MENU"
            st.rerun()

# FASE 3: CHAT INTERATIVO
else:
    # Mostra hist√≥rico (ocultando prompts t√©cnicos)
    for msg in st.session_state.messages:
        if msg["role"] != "system" and "O USU√ÅRIO SUBIU" not in str(msg["content"]) and "ACIONOU" not in str(msg["content"]) and "completou o question√°rio estrat√©gico" not in str(msg["content"]):
            with st.chat_message(msg["role"]):
                st.markdown(msg["content"])

    # L√≥gica Autom√°tica para detectar libera√ß√£o do MENU
    # N√£o √© mais necess√°rio detectar P4 porque o question√°rio √© um formul√°rio
    # O MENU j√° √© liberado automaticamente ap√≥s o question√°rio ser completado

    # INPUT DO USU√ÅRIO
    user_input = st.chat_input("Sua resposta...")

    # PROCESSAMENTO DE MENSAGEM
    if user_input:
        st.session_state.messages.append({"role": "user", "content": user_input})
        st.rerun()

    # RESPOSTA DA IA (Se a √∫ltima msg for User, a IA responde sozinha)
    if st.session_state.messages[-1]["role"] == "user":
        with st.chat_message("assistant"):
            with st.spinner("Headhunter analisando..."):
                response = get_response(st.session_state.messages, api_key)
                st.markdown(response)
        st.session_state.messages.append({"role": "assistant", "content": response})
        st.rerun()

    # MENU DE COMANDOS (Aparece s√≥ depois do Diagn√≥stico)
    if st.session_state.fase_atual in ["MENU", "EXECUCAO"] and st.session_state.messages[-1]["role"] == "assistant":
        st.markdown("---")
        col1, col2 = st.columns(2)
        with col1:
            if st.button("üöÄ /otimizador_cv_linkedin"):
                st.session_state.fase_atual = "EXECUCAO"
                trigger = "O usu√°rio ACIONOU: /otimizador_cv_linkedin. INICIE A ETAPA 1 (SEO)."
                st.session_state.messages.append({"role": "user", "content": trigger})
                st.rerun()

        with col2:
            if st.button("üìÑ Pular para Arquivo Final"):
                 trigger = "Pule para a ETAPA 5: ARQUIVO MESTRE."
                 st.session_state.messages.append({"role": "user", "content": trigger})
                 st.rerun()
